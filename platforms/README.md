# Platform Support for XSched

## Code Explanation

Platforms includes two parts of code in XSched: `XAL Lib` & `XShim Lib`, corresponding to `hal` & `shim` directory in each platform.

### XAL

The `XAL Lib` implements the `HwCommand` and `HwQueue` abstraction for each platform.

#### HwCommand

When hijacking a command to launch a kernel to XPU (such as `zeCommandListAppendLaunchKernel` in LevelZero, `cuLaunch` in CUDA), we need to encapsulate it as `HwCommand` and submit it to corresponding `XQueue`.

The main member functions implemented in `HwCommand` and their explanations are as follows:

| Interface               | Description                                                     |
| ----------------------- | --------------------------------------------------------------- |
| Enqueue()               | Call driver API to launch kernel                             |
| Synchronize()           | Synchronize HwCommand                                           |
| Synchronizable()        | Check if HwCommand can be synchronized                          |
| EnableSynchronization() | Enable HwCommand to be synchronized by appending event or fence |

#### HwQueue

`HwQueue` is an abstraction of real device queue (such as `zeCommandQueue` and `zeImmediateCommandList` in LevelZero, `CUstream` in CUDA). We need to implement different functions to support different preemption level.

<table>
  <tr>
    <th align="center">Preemption Level</th>
    <th align="center">Interface</th>
    <th align="center">Description</th>
  </tr>
  <tr>
    <td align="center" rowspan="2">Level-1</td>
    <td align="center">Launch(HwCommand)</td>
    <td align="left">Launch a HwCommand by calling HwCommand->Enqueue()</td>
  </tr>
  <tr>
    <td align="center">Synchronize()</td>
    <td align="left">Wait for all commands in the HwQueue to complete</td>
  </tr>
    <tr>
    <td align="center" rowspan="2">Level-2</td>
    <td align="center">Deactivate()</td>
    <td align="left">Deactivate the HwQueue to prevent all its commands from being selected for execution </td>
  </tr>
  <tr>
    <td align="center">Reactivate()</td>
    <td align="left">Reactivate the HwQueue to allow all its commands to be selected for execution</td>
  </tr>
    <tr>
    <td align="center" rowspan="2">Level-3</td>
    <td align="center">Interrupt()</td>
    <td align="left">Interrupt the running command of the HwQueue</td>
  </tr>
  <tr>
    <td align="center">Restore()</td>
    <td align="left">Restore the interrupted command of the HwQueue</td>
  </tr>
</table>

### XShim

The main function of `XShim Lib` is to change the applicaion workflow by intercepting XPU driver API calls. The `XShim` library provides transparency and allow applications to use XSched without modifications.

`XShim Lib` mainly consists of two files: `intercept.cpp` and `shim.cpp`.

- `intercept.cpp` can be auto generated by tools we provide. It provides transparent hijacking of Driver API through a unified macro definitio.
- `shim.cpp` implements the handling of hijacked APIs.

## Supported Platforms

| Name      | Usage                         |
| --------- | ----------------------------- |
| CUDA      | [README](cuda/README.md)      |
| HIP       | [README](hip/README.md)       |
| LevelZero | [README](levelzero/README.md) |
| OpenCL    | [README](opencl/README.md)    |
| AscendCL  | [README](ascend/README.md)    |
| cuDLA     | [README](cudla/README.md)     |
| VIP       | [README](vip/README.md)       |

If you are interested in supporting XSched on a new platform, please refer to our [example and guide](example/README.md).
